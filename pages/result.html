<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Hasil Prioritas Konsep</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../assets/Interior.png">
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="result-container">
        <h1><svg class="icon-inline icon-title" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Hasil Pemilihan Konsep Desain Interior</h1>
        
        <div id="resultContainer" class="result-content"></div>

        <div class="result-buttons">
            <button onclick="window.location.href='ideas.html'" class="btn gray-bg"><svg class="icon-btn" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Kembali ke Ideas</button>
            <button onclick="window.location.href='../index.html'" class="btn back-btn"><svg class="icon-btn" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg> Kembali ke Dashboard</button>
            <button onclick="exportResultPDF()" class="btn export-btn"><svg class="icon-btn" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Export ke PDF</button>
        </div>
    </div>

    <script>
        const CATEGORY_DATA = {
            internal: {
                name: 'Kinerja Internal',
                items: [
                    { ideaNum: 1, roomNum: 5, title: 'Ide aktivitas/kegiatan penting yang baru' },
                    { ideaNum: 2, roomNum: 6, title: 'Ide workflow (urutan pengerjaan tugas) baru' },
                    { ideaNum: 3, roomNum: 7, title: 'Ide role/responsibilities (staff) dengan tugas baru' },
                    { ideaNum: 4, roomNum: 8, title: 'Ide tools/technologies (peralatan) baru' }
                ]
            },
            customer: {
                name: 'Customer & Experience',
                items: [
                    { ideaNum: 1, roomNum: 4, title: 'Idea mengatasi "pains" (yang tidak diinginkan)' },
                    { ideaNum: 2, roomNum: 5, title: 'Idea mewujudkan "gains" (harapan)' },
                    { ideaNum: 3, roomNum: 6, title: 'Idea keadaan (konteks) penting yang dihadapi' }
                ]
            },
            competition: {
                name: 'Strategi Persaingan',
                items: [
                    { ideaNum: 1, roomNum: 7, title: 'Ide strategi sebagai market leader' },
                    { ideaNum: 2, roomNum: 8, title: 'Ide strategi sebagai market challenger' },
                    { ideaNum: 3, roomNum: 9, title: 'Ide strategi sebagai market follower' },
                    { ideaNum: 4, roomNum: 10, title: 'Idea strategi sebagai market nicher' },
                    { ideaNum: 5, roomNum: 11, title: 'Idea Unique Selling Propositions (USP) atau Value Propositions' },
                    { ideaNum: 6, roomNum: 12, title: 'Idea event atau aktivitas baru' }
                ]
            }
        };

        function loadDashboardData() {
            const saved = localStorage.getItem('dashboardData');
            if (!saved) return null;
            try {
                return JSON.parse(saved);
            } catch { return null; }
        }

        function getWinningCategory() {
            const data = loadDashboardData();
            if (!data) return 'internal';
            
            const internalAvg = hitungRata2(data, 'internal');
            const customerAvg = hitungRata2(data, 'customer');
            const competitionAvg = hitungRata2(data, 'competition');
            
            if (internalAvg >= customerAvg && internalAvg >= competitionAvg) {
                return 'internal';
            } else if (customerAvg >= internalAvg && customerAvg >= competitionAvg) {
                return 'customer';
            } else {
                return 'competition';
            }
        }

        function hitungRata2(data, type) {
            let total = 0, count = 0;
            for (let val of data[type].inputs) {
                if (val !== '') {
                    let num = parseFloat(val);
                    if (!isNaN(num)) { total += num; count++; }
                }
            }
            return count ? (total / count) : 0;
        }

        function loadIdeasData() {
            const saved = localStorage.getItem('ideasData');
            if (!saved) return {};
            try {
                return JSON.parse(saved);
            } catch { return {}; }
        }

        function renderNotesHtml(notesData) {
            if (Array.isArray(notesData) && notesData.length > 0) {
                return '<ol style="margin: 0.25rem 0 0 1.25rem; font-size: 0.875rem; color: #374151;">' +
                    notesData.map(n => '<li style="margin-bottom: 0.2rem;">' + n + '</li>').join('') + '</ol>';
            } else if (typeof notesData === 'string' && notesData) {
                return '<p style="font-size: 0.875rem;">' + notesData + '</p>';
            }
            return '<p style="font-size: 0.875rem; color: #9ca3af;"><em>-</em></p>';
        }

        function loadIdentitas() {
            const identitas = localStorage.getItem('identitasData');
            if (identitas) {
                try {
                    return JSON.parse(identitas);
                } catch { return {}; }
            }
            return {};
        }

        function tampilkanHasil() {
            const dashData = loadDashboardData();
            const identitas = loadIdentitas();
            const category = getWinningCategory();
            const categoryConfig = CATEGORY_DATA[category];
            const ideasData = loadIdeasData();
            const categoryIdeas = ideasData[category] || {};

            if (!dashData) {
                document.getElementById('resultContainer').innerHTML = '<p class="error">Belum ada data. Silakan isi di dashboard utama.</p>';
                return;
            }

            const internalAvg = hitungRata2(dashData, 'internal');
            const customerAvg = hitungRata2(dashData, 'customer');
            const competitionAvg = hitungRata2(dashData, 'competition');

            let resultText = '', deskripsi = '';
            if (internalAvg === 0 && customerAvg === 0 && competitionAvg === 0) {
                resultText = 'Belum ada skor yang diisi.';
            } else if (internalAvg >= customerAvg && internalAvg >= competitionAvg) {
                resultText = 'Prioritas: Penguatan Kinerja Internal';
                deskripsi = 'Fokus pada efisiensi operasional, produktivitas tim, dan optimalisasi proses internal untuk meningkatkan pendapatan.';
            } else if (customerAvg >= internalAvg && customerAvg >= competitionAvg) {
                resultText = 'Prioritas: Engagement & Experience Customer';
                deskripsi = 'Utamakan pengalaman pelanggan, personalisasi layanan, dan menciptakan hubungan jangka panjang untuk mendorong revenue.';
            } else {
                resultText = 'Prioritas: Strategi Diferensiasi Persaingan';
                deskripsi = 'Bangun keunikan yang membedakan dari kompetitor, ciptakan nilai tambah yang sulit ditiru, dan perkuat posisi pasar.';
            }

            let container = document.getElementById('resultContainer');
            let html = `
                <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                    <div style="font-size: 0.9rem; line-height: 1.8;">
                        <div><svg class="icon-inline" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> <strong>Nama Mahasiswa:</strong> ${identitas.namaMahasiswa || '-'}</div>
                        <div><svg class="icon-inline" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> <strong>Judul Tugas:</strong> ${identitas.judulTugas || '-'}</div>
                    </div>
                </div>
                <div class="result-header">
                    <h2>${resultText}</h2>
                    <p>${deskripsi}</p>
                </div>
                <div class="result-details">
                    <div class="detail-card blue">
                        <h3><svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg> Kinerja Internal</h3>
                        <p class="avg">${internalAvg.toFixed(2)}</p>
                        <p><strong>Catatan:</strong></p>
                        ${renderNotesHtml(dashData.internal.notes || dashData.internal.note)}
                    </div>
                    <div class="detail-card green">
                        <h3><svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg> Customer</h3>
                        <p class="avg">${customerAvg.toFixed(2)}</p>
                        <p><strong>Catatan:</strong></p>
                        ${renderNotesHtml(dashData.customer.notes || dashData.customer.note)}
                    </div>
                    <div class="detail-card red">
                        <h3><svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg> Persaingan</h3>
                        <p class="avg">${competitionAvg.toFixed(2)}</p>
                        <p><strong>Catatan:</strong></p>
                        ${renderNotesHtml(dashData.competition.notes || dashData.competition.note)}
                    </div>
                </div>

                <div style="margin-top: 2rem; margin-bottom: 3rem;">
                    <h3><svg class="icon-inline" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Preview Idea & Ruangan</h3>
            `;

            const allCategories = ['internal', 'customer', 'competition'];
            allCategories.forEach(cat => {
                const catConfig = CATEGORY_DATA[cat];
                const catIdeas = ideasData[cat] || {};

                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 0.75rem; font-size: 1rem; color: #1f2937;">${catConfig.name}</h4>
                        <div style="background: #f9fafb; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e5e7eb;">
                `;

                catConfig.items.forEach(item => {
                    const ideaKey = `idea_${item.ideaNum}`;
                    const roomKey = `room_${item.roomNum}`;
                    const ideaInputs = catIdeas[ideaKey] || [];
                    const roomInputs = catIdeas[roomKey] || [];
                    const filledIdeas = ideaInputs.filter(i => i && i.trim());

                html += `
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #d1d5db;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            Idea #${item.ideaNum}: ${item.title}
                        </div>
                        <div style="margin-left: 1rem; color: #4b5563;">
                `;

                if (filledIdeas.length > 0) {
                    filledIdeas.forEach((idea, idx) => {
                        const room = roomInputs[ideaInputs.indexOf(idea)] || '(belum ditentukan)';
                        html += `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 0.375rem; border-left: 3px solid #0891b2;">
                                <div style="margin-bottom: 0.375rem;"><svg class="icon-inline" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg> <strong>Idea:</strong> ${idea}</div>
                                <div style="color: #059669;"><svg class="icon-inline" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> <strong>Ruangan:</strong> ${room}</div>
                            </div>
                        `;
                    });
                } else {
                    html += `<div style="color: #9ca3af; font-style: italic;">- Belum ada idea yang diisi -</div>`;
                }

                html += `
                        </div>
                    </div>
                `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
            `;

            container.innerHTML = html;
        }

        function exportResultPDF() {
            const category = getWinningCategory();
            const categoryConfig = CATEGORY_DATA[category];
            const ideasData = loadIdeasData();
            const categoryIdeas = ideasData[category] || {};
            const dashData = loadDashboardData();
            const identitas = loadIdentitas();

            if (!dashData) {
                alert('Data dashboard tidak ditemukan. Silakan isi di dashboard terlebih dahulu.');
                return;
            }

            const element = document.createElement('div');
            element.style.padding = '5px';
            element.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            element.style.lineHeight = '1.3';
            element.style.color = '#333';

            const getAvg = (data, type) => {
                if (!data || !data[type] || !data[type].inputs) return '0';
                const inputs = data[type].inputs.filter(v => v);
                if (inputs.length === 0) return '0';
                const sum = inputs.reduce((s, v) => s + (parseFloat(v) || 0), 0);
                return (sum / inputs.length).toFixed(1);
            };

            let html = `
                <div style="max-width: 210mm;">
                    <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; margin-bottom: 8px;">
                        <h1 style="font-size: 18px; font-weight: 700; margin: 0 0 2px 0;">Hasil Pemilihan Konsep Desain Interior</h1>
                        <div style="color: #6b7280; font-size: 11px; margin-bottom: 0px;">Kategori: <strong>${categoryConfig.name}</strong></div>
                        <div style="color: #6b7280; font-size: 9px;">Tanggal: ${new Date().toLocaleString('id-ID')}</div>
                    </div>

                    <div style="background: #f0f9ff; padding: 5px; border-radius: 4px; margin-bottom: 8px; border-left: 2px solid #3b82f6;">
                        <div style="font-size: 10px; color: #1f2937;">
                            <div><strong>Nama:</strong> ${identitas.namaMahasiswa || '-'}</div>
                            <div><strong>Judul:</strong> ${identitas.judulTugas || '-'}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 8px;">
                        <h3 style="margin-bottom: 4px; font-size: 12px;">Ringkasan Skor</h3>
                        <div style="background: #f9fafb; padding: 5px; border-radius: 4px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px;">
                            <div style="text-align: center; padding: 4px; background: white; border-radius: 3px;">
                                <div style="color: #6b7280; font-size: 9px;">Kinerja Internal</div>
                                <div style="font-size: 14px; font-weight: 700; color: #3b82f6;">${getAvg(dashData, 'internal')}</div>
                            </div>
                            <div style="text-align: center; padding: 4px; background: white; border-radius: 3px;">
                                <div style="color: #6b7280; font-size: 9px;">Customer</div>
                                <div style="font-size: 14px; font-weight: 700; color: #22c55e;">${getAvg(dashData, 'customer')}</div>
                            </div>
                            <div style="text-align: center; padding: 4px; background: white; border-radius: 3px;">
                                <div style="color: #6b7280; font-size: 9px;">Persaingan</div>
                                <div style="font-size: 14px; font-weight: 700; color: #ef4444;">${getAvg(dashData, 'competition')}</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 8px;">
                        <h3 style="margin-bottom: 4px; font-size: 12px;">Rincian Idea & Ruangan</h3>
            `;

            const pdfCategories = ['internal', 'customer', 'competition'];
            pdfCategories.forEach(cat => {
                const pdfCatConfig = CATEGORY_DATA[cat];
                const pdfCatIdeas = ideasData[cat] || {};

                html += `<div style="margin-bottom: 6px;"><div style="font-weight: 700; font-size: 10px; margin-bottom: 3px; color: #1e40af;">${pdfCatConfig.name}</div>`;

                pdfCatConfig.items.forEach(item => {
                    const ideaKey = `idea_${item.ideaNum}`;
                    const roomKey = `room_${item.roomNum}`;
                    const ideaInputs = pdfCatIdeas[ideaKey] || [];
                    const roomInputs = pdfCatIdeas[roomKey] || [];
                    const filledIdeas = ideaInputs.filter(i => i && i.trim());

                html += `
                    <div style="margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 3px; font-size: 10px;">
                            Idea #${item.ideaNum}: ${item.title}
                        </div>
                `;

                if (filledIdeas.length > 0) {
                    filledIdeas.forEach((idea, idx) => {
                        const room = roomInputs[ideaInputs.indexOf(idea)] || '(belum ditentukan)';
                        html += `
                            <div style="margin-bottom: 2px; padding: 3px; background: #f9fafb; border-left: 2px solid #2563eb; font-size: 9px;">
                                <div><strong>Idea:</strong> ${idea}</div>
                                <div style="color: #059669;"><strong>Ruangan:</strong> ${room}</div>
                            </div>
                        `;
                    });
                } else {
                    html += `<div style="color: #9ca3af; font-style: italic; font-size: 9px;">Belum ada idea yang diisi</div>`;
                }

                html += `</div>`;
            });

                html += `</div>`;
            });

            html += `
                    </div>
                </div>
            `;

            element.innerHTML = html;

            document.body.appendChild(element);

            const opt = {
                margin: [5, 5, 5, 5],
                filename: `hasil-konsep-${category}-${new Date().getTime()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                document.body.removeChild(element);
            });
        }

        window.onload = tampilkanHasil;
    </script>
</body>
</html>
